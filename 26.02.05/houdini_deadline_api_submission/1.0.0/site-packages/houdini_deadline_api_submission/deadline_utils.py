"""Utility functions for various Deadline related operations."""

# Import built-in modules
import logging
import os

# Import third-party modules
from Deadline.DeadlineConnect import DeadlineCon
from farm_environment import FarmEnvironment
from hal_config import Configuration

# Import local modules
from houdini_deadline_api_submission.singleton import Singleton


class DeadlineConnection(object):
    """Singleton class to retrieve a DeadlineCon object."""

    __metaclass__ = Singleton

    def __init__(self):
        """Initialize the Deadline connection."""
        config = Configuration()
        deadline_info = config.query("deadline_api", "webservice")
        self.connection = DeadlineCon(deadline_info["hostname"], deadline_info["port"])


def get_deadline_connect():
    """Return a Deadline Connect object.

    Returns:
        Deadline.DeadlineConnect.DeadlineCon: Connection object to the
            Deadline API.

    """
    connection = DeadlineConnection()
    return connection.connection


def get_deadline_pools(remove_none=True):
    """Return all available Deadline pool names.

    Args:
        remove_none (bool, optional): Remove 'none' entries from the list.
            Defaults to True.

    Returns:
        list of str: Name of available Deadline Pools.

    """
    deadline_con = get_deadline_connect()
    pools = deadline_con.Pools.GetPoolNames()
    if remove_none:
        try:
            pools.pop(pools.index("none"))
        except ValueError:
            logger = logging.getLogger(__name__)
            logger.debug('Tried to remove "none" pool while it was not ' "present.")
    pools.sort()
    return pools


def get_deadline_groups(remove_none=True):
    """Return all available Deadline group names.

    Args:
        remove_none (bool, optional): Remove 'none' entries from the list.
            Defaults to True.

    Returns:
        list of str: Name of available Deadline Groups.

    """
    deadline_con = get_deadline_connect()
    groups = deadline_con.Groups.GetGroupNames()
    if remove_none:
        try:
            groups.pop(groups.index("none"))
        except ValueError:
            logger = logging.getLogger(__name__)
            logger.debug('Tried to remove "none" group while it was not ' "present.")
    groups.sort()
    return groups


def get_framestring(start, end, inc=1, use_first_last_middle=False):
    """Generate a Deadline frame string.

    A Deadline frame string is a string defining the start, end, and increment
    of a frame range. Some Examples:
    - '1001-1010' (Frame 1001 to 1010).
    - '1001-1010x5' (Frame 1001 to 1010 with an increment of 5).
    - '1010-1001' (Frame 1001 to 1010 in reverse).
    - '1001,1002,1010' (Frame 1001, 1002 and 1010).
    - '1001-1100x10,1001-1100x5,1001-1100' (First Render every 10th Frame
      between 1001 and 1100, then every 5th frame that wasn't rendered yet,
      then the rest).

    Args:
        start (int): Start frame.
        end (int): End frame.
        inc (int, optional): Increment of the frames.
        use_first_last_middle (bool, optional): If True, render the first, last
            and middle frame, then the middle frame of each segment created
            this way. This repeats until the difference between frames is below
            10. Defaults to False.

    Returns:
        str: Deadline compatible framestring.

    """
    format_string = "{start}-{end}x{inc}"
    if inc == 1:
        format_string = "{start}-{end}"
    if use_first_last_middle:
        raise NotImplementedError(
            "First-Last-Middle Frame string is not yet " "implemented."
        )
    return format_string.format(start=start, end=end, inc=inc)


def convert_to_deadline_env(orig):
    """Convert all entries to a Deadline compatible dictionary.

    Args:
        orig (dict): Original dictionary to convert.

    Returns:
        dict: Deadline Submission compatible values.

    """
    deadline_dict = {}
    for env_variable_index, (key, val) in enumerate(sorted(orig.items())):
        deadline_key = "EnvironmentKeyValue{}".format(env_variable_index)
        deadline_val = "{}={}".format(key, val)
        deadline_dict[deadline_key] = deadline_val
    return deadline_dict


def append_to_deadline_env(deadline_dict, key, value):
    """Append an environment variable to a Deadline environment dictionary.

    If a dictionary was already converted to a Deadline compatible dictionary,
    we need to use this function instead of simply adding to the dictionary.

    Args:
        deadline_dict (dict): Deadline compatible dictionary.
        key (str): Name of the environment variable to add.
        value (str): Value of the environment variable to add.

    """
    index = 0
    for dl_key in deadline_dict.keys():
        if dl_key.startswith("EnvironmentKeyValue"):
            index += 1

    deadline_dict["EnvironmentKeyValue{}".format(index)] = "{}={}".format(key, value)


def get_hal_environment_dict(extra_dict=None):
    """Create a Deadline conform dictionary of relevant environment variables.

    This function will create a dictionary with any environment variable
    starting with 'HAL_', some extra entries needed for the HAL_Houdini
    Deadline Plugin, and all the entries from the optional extra_dict.

    Args:
        extra_dict (dict, optional): Additional entries for the dictionary.

    Returns:
        dict: Job relevant environment variables in a Deadline conform style.

        Example:
            {
                'EnvironmentKeyValue0': 'HAL_DEADLINE_USE_HAL=True',
                'EnvironmentKeyValue1': 'HAL_ASSETSTORE_ROOT=U:/',
                ...
            }

    """
    extra_dict = extra_dict if extra_dict else {}
    deadline_dict = {}
    farm_environment = FarmEnvironment(False)

    keys = filter(lambda k: k.startswith("HAL_"), farm_environment)
    for key in keys:
        deadline_dict[key] = farm_environment[key]
    deadline_dict.update(extra_dict)

    return convert_to_deadline_env(deadline_dict)


def submit_job(job_info, plugin_info, deadline_con=None):
    """Submit a job to Deadline.

    Args:
        job_info (dict):
        plugin_info (dict):
        deadline_con (Deadline.DeadlineConnect.DeadlineCon, optional):
            Deadline connection object. If not given, a connection will
            automatically be established.

    Returns:
        int: ID of submitted job.

    """
    # If a function is passed as an information, we want to use the return value of the
    # function. This allows us to get information right before sending it to Deadline.
    for deadline_info in (job_info, plugin_info):
        for key, dl_info_value in deadline_info.items():
            if callable(dl_info_value):
                deadline_info[key] = dl_info_value()

    if not deadline_con:
        deadline_con = get_deadline_connect()
    return deadline_con.Jobs.SubmitJob(job_info, plugin_info, idOnly=True)["_id"]
