"""Collection of utility Deadline jobs."""

# Import built-in modules
import os

# Import local modules
from houdini_deadline_api_submission import cleanup
from houdini_deadline_api_submission import constants
from houdini_deadline_api_submission import utils
from houdini_deadline_api_submission.job.base import BaseDeadlineJob


class CleanUpJob(BaseDeadlineJob):
    """Special Deadline Job used to clean the output of another job."""

    def __init__(
        self,
        folder,
        file_name_prefix,
        node,
        dependencies,
        submitter_node=None,
        plugin_name=constants.CMD_LINE_PLUGIN,
        job_info_overrides=None,
        plugin_info_overrides=None,
        wedge_values=None,
        wedge_index=None,
        output_parm_name=None,
        node_parm_overrides=None,
        timestamp=None,
    ):
        """Deadline job for deleting the output of another job.

        Args:
            folder (str): Path to the folder we want to clean up.
            file_name_prefix (str): All files with this prefix in the folder
                will be deleted.
            node (hou.Node): ROP Node in the Houdini scene, used to gather
                overrides and job attributes.
            dependencies (:obj:`list` of :obj:`houdini_deadline_api_submission.
                job.base.BaseDeadlineJob`): List of all jobs this job depends
                on to be able to successfully run.
            plugin_name (str, optional): Name of the Deadline Plugin to use.
            job_info_overrides (dict, optional): Values in this dictionary
                will override any job info values queried from the node.
            plugin_info_overrides (dict, optional): Values in this dictionary
                will override any plugin info values queried from the node.
            wedge_values (list, optional): Parameters to wedge and their wedged
                value.
            wedge_index (int, optional): Index of the given wedge.
            output_parm_name (str, optional): Name of the output parameter.
                This is used to set the OutputDirectory0 and OutputFilename0
                parameter on submission.
            node_parm_overrides (dict, optional): Overrides that will adjust
                parameters on the node when submitting, and will reset these
                parameters to their previous value after submitting this job.
            timestamp (str, optional): The timestamp that will be used for
                various operations in this job. If no timestamp is given, a
                timestamp with the current time will be used.

        """

        super(CleanUpJob, self).__init__(
            node,
            dependencies,
            submitter_node,
            plugin_name,
            job_info_overrides,
            plugin_info_overrides,
            wedge_values,
            wedge_index,
            output_parm_name,
            node_parm_overrides,
            timestamp=timestamp,
            save_copy=False,
        )

        # Write cleanup script.
        cleanup_script = cleanup.create_cleanup_script(file_name_prefix, folder)

        # Fill CommandLine arguments.
        self.plugin_info["Executable"] = "hal"
        command = ["--run-by-tool", "+p", "python-2", "run", "python", cleanup_script]
        self.plugin_info["Arguments"] = " ".join(command)

        # Adjust job info.
        self.job_info["Frames"] = "1"
        self.job_info["IsFrameDependent"] = False
        self.add_as_dependency = False

    @classmethod
    def from_job(cls, job):
        """Return a CleanUpJob that will delete the output of the given job.

        Args:
            job (houdini_deadline_api_submission.job.base.BaseDeadlineJob):

        Returns:
            CleanUpJob: Job used to clean up the output of the given input job.

        """
        folder = job.job_info["OutputDirectory0"]
        file_name_prefix = job.job_info["OutputFilename0"].split(".")[0]

        new_job = cls(
            folder,
            file_name_prefix,
            job.node,
            job.dependencies,
            job.submitter_node,
            constants.CMD_LINE_PLUGIN,
            job.job_info,
            job.plugin_info,
            job.wedge_values,
            job.wedge_index,
            job.output_parm,
            timestamp=job.timestamp,
        )
        new_job.job_info["Name"] = "{} - Cleanup".format(new_job.job_info["Name"])

        return new_job
