"""Functions to create, edit, and apply wedges."""

# Import build-in modules
# Import built-in modules
import os

# Import third-party modules
import hou  # pylint: disable=import-error

# Import local modules
from houdini_deadline_api_submission import constants
from houdini_deadline_api_submission import math_utils

# Global variable used to store wedged parms and their original values.
_ORIG_WEDGED_VALUES = {}


def get_wedge_value(node, wedge_id, step):
    """Return the target wedge value in the current step.

    Args:
        node (hou.Node): Node to get the wedge info from.
        wedge_id (int): ID of the wedge parameter. Starts at 0.
        step (int): Current step, used to determine the wedge value.

    Returns:
        float: Value in the current iteration.

    """
    min_, max_ = node.evalParmTuple(constants.WEDGE_RANGE.format(id=wedge_id))
    min_steps = 1
    max_steps = node.evalParm(constants.WEDGE_STEPS.format(id=wedge_id))
    if min_steps == max_steps:
        return min_
    return math_utils.refit_value(
        float(step), float(min_steps), float(max_steps), float(min_), float(max_)
    )


def get_wedge_info(node, wedge_id, step, strict=True):
    """Return wedge info for the given wedge_id on the given node.

    Args:
        node (hou.Node): Node to get the wedge info from.
        wedge_id (int): ID of the wedge parameter. Starts at 0.
        step (int): Current step, used to determine the wedge value.
        strict (bool, optional): If True, display a message and raise an
            AttributeError. If False, will simply return an empty list.
            Defaults to True.

    Returns:
        list: Info about this wedge.

    Raises:
        AttributeError: If a wedged channel is missing / invalid.

    Examples:
        >>> node = hou.node('/out/mantra1')
        >>> get_wedge_info(node, 0, 0)
        [
            'width',
            hou.Parm('/obj/source/box1/sizex'),
            1
        ]

    """
    wedge_name = node.parm(constants.WEDGE_NAME.format(id=wedge_id))
    wedge_channel_orig = node.parm(constants.WEDGE_CHANNEL.format(id=wedge_id))
    wedge_value = get_wedge_value(node, wedge_id, step)

    # Support a channel reference but also a string containing the full path
    # to the wedged parameter (the old way).
    if wedge_channel_orig.getReferencedParm() == wedge_channel_orig:
        wedge_channel = hou.parm(wedge_channel_orig.eval())
    else:
        wedge_channel = wedge_channel_orig.getReferencedParm()

    # Show an error box to the user if the channel reference is missing.
    if not wedge_channel:
        if not strict:
            return []
        msg = (
            "Channel reference on a wedge is missing:\n{} needs to be "
            "either a single reference to a parameter or the absolute path "
            "to a parameter as a string.".format(wedge_channel_orig.path())
        )
        hou.ui.displayMessage(msg)
        raise AttributeError(msg)

    # If no channel name is given, use the name of the wedged parameter as the
    # default value.
    if not wedge_name.eval():
        wedge_name = wedge_channel.name().split("/")[-1]
    else:
        wedge_name = wedge_name.eval()

    return [wedge_name, wedge_channel, wedge_value]


def get_wedges(node, strict=True):
    """Return wedges set in the given node.

    Args:
        node (hou.Node): Node whose wedges will be returned.
        strict (bool, optional): If True, display a message and raise an
            AttributeError on a faulty wedge. If False, such a faulty wedge
            will be added as an empty wedge. Defaults to True.

    Returns:
        list: Wedged channels and their wedged value.

    Examples:
        >>> # Two Wedged Parameters: sizex: 1-2, sizey: 1-2
        >>> get_wedges(hou.Node('/out/geometry1'))
        [
            [
                [
                    'width',
                    hou.Parm('/obj/source/box1/sizex'),
                    1
                ],
                [
                    'height',
                    hou.Parm('/obj/source/box1/sizey'),
                    1
                ]
            ],
            [
                [
                    'width',
                    hou.Parm('/obj/source/box1/sizex'),
                    2
                ],
                [
                    'height',
                    hou.Parm('/obj/source/box1/sizey'),
                    1
                ]
            ],
            [
                [
                    'width',
                    hou.Parm('/obj/source/box1/sizex'),
                    1
                ],
                [
                    'height',
                    hou.Parm('/obj/source/box1/sizey'),
                    2
                ]
            ],
            [
                [
                    'width',
                    hou.Parm('/obj/source/box1/sizex'),
                    2
                ],
                [
                    'height',
                    hou.Parm('/obj/source/box1/sizey'),
                    2
                ]
            ]
        ]

    """
    try:
        amount_of_parms = node.parm(constants.WEDGE_PARMS).eval()
        # If no wedges are configured, return empty list.
        if not amount_of_parms:
            return []
    except AttributeError:
        return []

    # Return empty list if checkbox to use wedges is turned off.
    if not node.evalParm(constants.WEDGE_USE_WEDGE):
        return []

    # Needs to be initialized with a list inside a list so the merging works
    # properly.
    all_wedges = [[]]

    # We have to match up each step of the wedge with each other step of each
    # other wedge parameter. To do this, we need to merge every newly created
    # wedge step with the previous ones.
    for id_ in range(amount_of_parms):
        this_wedge = []
        steps_amount = node.evalParm(constants.WEDGE_STEPS.format(id=id_))
        # Incrementing the step value by 1 because the range in the HDA starts
        # at 1, so the fitting of the values can work properly.
        for step in range(1, steps_amount + 1):
            wedge_info = get_wedge_info(node, id_, step, strict=strict)
            this_wedge.append(wedge_info)
        all_wedges = merge_wedges(all_wedges, this_wedge)

    return all_wedges


def merge_wedges(other_wedges, add_wedges):
    """Merge all wedges in add_wedges into formerly created wedges.

    Args:
        other_wedges (list): Already created wedges.
        add_wedges (list): Wedges to add.

    Returns:
        list: Merged wedges.

    """
    all_wedges = []
    for add_wedge in add_wedges:
        for current_wedge in other_wedges[:]:
            current_wedge = current_wedge[:]
            current_wedge.append(add_wedge)
            all_wedges.append(current_wedge)
    return all_wedges


def apply_wedge(wedge, wedgenum):
    """Applies all values configured in the given wedge.

    Args:
        wedge (list): A single wedge configuration.
        wedgenum (int): Running number of the wedge.

    Examples:
        >>> # A wedge with 2 values: width = 1, height = 2.
        >>> wedge = [
        ...     [
        ...         'width',
        ...         hou.parm('/obj/source/box1/sizex'),
        ...         1
        ...     ],
        ...     [
        ...         'height',
        ...         hou.parm('/obj/source/box1/sizey'),
        ...         2
        ...     ]
        ... ]
        >>> apply_wedge(wedge)

    """
    os.environ["WEDGENUM"] = str(wedgenum)
    hou.putenv("WEDGENUM", str(wedgenum))

    wedge_name = "-".join(("{}{}".format(name, value) for name, parm, value in wedge))
    os.environ["WEDGE"] = wedge_name
    hou.putenv("WEDGE", wedge_name)

    # Store original values.
    global _ORIG_WEDGED_VALUES
    for name, parm, value in wedge:
        parm_path = parm.path()
        if parm_path not in _ORIG_WEDGED_VALUES:
            _ORIG_WEDGED_VALUES[parm_path] = parm.eval()

    # Set to the current wedge.
    for name, parm, value in wedge:
        parm.set(value)


def reset_wedging():
    """Reset all wedged values to what they were before wedging."""
    global _ORIG_WEDGED_VALUES
    for parm_path, orig_value in _ORIG_WEDGED_VALUES.items():
        hou.parm(parm_path).set(orig_value)

    # Clean environment values.
    del os.environ["WEDGENUM"]
    hou.unsetenv("WEDGENUM")

    del os.environ["WEDGE"]
    hou.unsetenv("WEDGE")

    # Reset storage of original values.
    _ORIG_WEDGED_VALUES = {}


def add_wedging_parms(node):
    """Add all HAL Wedging parms to the given node.

    Args:
        node (hou.Node): Node to add the parms to.

    """
    # TODO Add 'Local Render Single Wedge' and 'Local Render All Wegdes' Buttons.
    # TODO Add 'Inherit Wedges from...' Node Parm.
    parm_template_grp = node.parmTemplateGroup()
    wedge_main_folder = hou.FolderParmTemplate(
        "hal_wedge_folder", constants.WEDGE_MAIN_FOLDER, folder_type=hou.folderType.Tabs
    )
    wedge_mparm_folder = hou.FolderParmTemplate(
        constants.WEDGE_PARMS, "Wedge Parms", folder_type=hou.folderType.MultiparmBlock
    )
    # Setting the first instance of multiparm numbering to 0, so it matches the
    # Python range() function.
    wedge_mparm_folder.setTags({"multistartoffset": "0"})
    use_wedges = hou.ToggleParmTemplate(
        constants.WEDGE_USE_WEDGE, "Use HAL Wedges", default_value=True
    )
    total_wedges_label = hou.LabelParmTemplate(
        "hal_total_wedge_lbl",
        "HAL Total Wedges",
        column_labels=('Total Wedges: `chs("hal_wedge_amount")`',),
    )
    total_wedges_label.hideLabel(True)
    total_wedges = hou.IntParmTemplate(
        "hal_wedge_amount",
        "HAL Wedge Amount",
        1,
        default_expression=(
            "node = hou.pwd()\n"
            'amount = node.evalParm("{wedge_parms}")\n'
            "wedges = 1\n"
            "for i in range(amount):\n"
            '    wedges *= node.evalParm("{wedge_steps}".format(id=i))\n'
            "return wedges".format(
                wedge_parms=constants.WEDGE_PARMS, wedge_steps=constants.WEDGE_STEPS
            ),
        ),
        default_expression_language=(hou.scriptLanguage.Python,),
    )
    total_wedges.hide(True)
    wedge_main_folder.addParmTemplate(use_wedges)
    wedge_main_folder.addParmTemplate(total_wedges_label)
    wedge_main_folder.addParmTemplate(total_wedges)

    wedge_name = hou.StringParmTemplate(
        constants.WEDGE_NAME.format(id="#"),
        "Name",
        1,
        conditionals={
            hou.parmCondType.DisableWhen: "{{ {} == 0 }}".format(
                constants.WEDGE_USE_WEDGE
            )
        },
    )
    wedge_channel = hou.StringParmTemplate(
        constants.WEDGE_CHANNEL.format(id="#"),
        "Channel",
        1,
        conditionals={
            hou.parmCondType.DisableWhen: "{{ {} == 0 }}".format(
                constants.WEDGE_USE_WEDGE
            )
        },
    )
    wedge_range = hou.FloatParmTemplate(
        constants.WEDGE_RANGE.format(id="#"),
        "Range",
        2,
        default_value=(1, 2),
        conditionals={
            hou.parmCondType.DisableWhen: "{{ {} == 0 }}".format(
                constants.WEDGE_USE_WEDGE
            )
        },
    )
    wedge_steps = hou.IntParmTemplate(
        constants.WEDGE_STEPS.format(id="#"),
        "Steps",
        1,
        default_value=(2,),
        min=1,
        min_is_strict=True,
        default_expression=(
            'range = hou.pwd().parmTuple("{wedge_range}".format(id="#")).eval()\n'
            "return range[1] - range[0] + 1".format(wedge_range=constants.WEDGE_RANGE),
        ),
        default_expression_language=(hou.scriptLanguage.Python,),
        conditionals={
            hou.parmCondType.DisableWhen: "{{ {} == 0 }}".format(
                constants.WEDGE_USE_WEDGE
            )
        },
    )

    wedge_mparm_folder.addParmTemplate(wedge_name)
    wedge_mparm_folder.addParmTemplate(wedge_channel)
    wedge_mparm_folder.addParmTemplate(wedge_range)
    wedge_mparm_folder.addParmTemplate(wedge_steps)
    wedge_main_folder.addParmTemplate(wedge_mparm_folder)

    parm_template_grp.append(wedge_main_folder)
    node.setParmTemplateGroup(parm_template_grp)
