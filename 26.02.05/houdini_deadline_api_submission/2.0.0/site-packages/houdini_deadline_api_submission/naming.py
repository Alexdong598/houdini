"""Functions to get and set file paths."""

# Import built-in modules
import fnmatch
from getpass import getuser
import os

# Import third-party modules
import hou  # pylint: disable=import-error

# Import local modules
from houdini_deadline_api_submission import config
from houdini_deadline_api_submission import constants


def get_username():
    """Return the username of the currently logged in user.

    This function tries to first get the environment variable
    `HAL_USER_LOGIN`, which allows a job on the farm to still remember the
    name of the user that submitted it. If it can't find this variable, it
    will use the currently logged in user.

    Returns:
        str: Current user.

    """
    return os.environ.get("HAL_USER_LOGIN", getuser())


def get_output_parm(node, parm_name=None):
    """Return the parameter defining the output file path.

    Args:
        node (hou.Node): Node to query the output parameter from.
        parm_name (str, optional): If given, override any default searches.

    Returns:
        hou.Parm: Output path parameter.

    Raises:
        ValueError: If a given parm_name does not exist.
        AttributeError: If more or less than 1 attribute is found via the
            basic patterns. To solve this, the node type has to be configured.

    """
    if parm_name:
        if isinstance(parm_name, hou.Parm):
            parm_name = parm_name.name()
        parm = node.parm(parm_name)
        if parm:
            return parm
        raise ValueError(
            "Parameter not available: {}/{}".format(node.path(), parm_name)
        )

    parm_names = [parm.name() for parm in node.parms()]
    special_searches = config.get_config("special_output_parms")
    try:
        patterns = [special_searches[node.type().nameComponents()[-2]]]
    except KeyError:
        patterns = ["*output", "filename", "vm_picture"]

    matched_parm_names = []
    for pattern in patterns:
        matched_parm_names += fnmatch.filter(parm_names, pattern)

    if len(matched_parm_names) != 1:
        # Most Shell ROPs don't have an output value, but if they are actually
        # outputting something and are implemented correctly by providing an
        # output parameter, we want to make sure it works by only returning
        # None when it would error otherwise.
        if node.type().name() == "shell":
            return
        raise AttributeError(
            "{} attributes match the output filters: {}\n"
            "This has to be 1, so it can match a single "
            "parameter. \nInform a TD to implement the node "
            "type '{}'.".format(
                len(matched_parm_names), matched_parm_names, node.type().name()
            )
        )

    return node.parm(matched_parm_names[0])


def is_cache_and_render(node):
    """Return True if given node needs to be cached AND rendered.

    Args:
        node (hou.Node): Node to get the information from.

    Returns:
        bool: True if the given node needs to be cached AND rendered.

    """
    parm = node.parm(constants.RENDER_MODE)
    # This is the default behaviour for render nodes, so if we can't find the
    # parameter, we will just default to returning True right here.
    if not parm:
        return True

    if parm.eval() == constants.RENDER_MODE_CACHE_RENDER:
        return True
    return False


def is_only_cache(node):
    """Return True if given node needs to be cached ONLY.

    Args:
        node (hou.Node): Node to get the information from.

    Returns:
        bool: True if the given node needs to be cached ONLY.

    """
    parm = node.parm(constants.RENDER_MODE)
    if not parm:
        return False
    if parm.eval() == constants.RENDER_MODE_CACHE_ONLY:
        return True
    return False


def is_only_render(node):
    """Return True if given node will be rendered straight out of Houdini.

    Args:
        node (hou.Node): Node to get the information from.

    Returns:
        bool: True if the given node needs to be rendered ONLY.

    """
    parm = node.parm(constants.RENDER_MODE)
    if not parm:
        return False
    if parm.eval() == constants.RENDER_MODE_RENDER_ONLY:
        return True
    return False
