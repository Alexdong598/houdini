"""Collection of utility functions to manipulate node parameters."""

# Import built-in modules
import copy

# Import third-party modules
import hou  # pylint:disable=import-error

# Import local modules
from houdini_deadline_api_submission import config
from houdini_deadline_api_submission import constants
from houdini_deadline_api_submission import deadline_utils


def get_job_info(node, goal_node=None, extra_infos=None):
    """Return deadline job info of the given node.

    Args:
        node (hou.Node): Node to get the job info of.
        goal_node (hou.Node, optional): Optional node that will be used to
            resolve any occurrences of $OS.
        extra_infos (dict, optional): Any optional extra infos that should be
            added as Deadline Environment Variable.

    Returns:
        dict: Job information usable by Deadline.

    """
    extra_infos = extra_infos if extra_infos else {}

    goal_node = goal_node if goal_node else node
    job_info = get_parm_values(
        node,
        prefix=constants.JOB_OVERRIDE_PARM_PREFIX,
        remove_prefix=True,
        goal_node=goal_node,
    )
    job_info.update(deadline_utils.get_hal_environment_dict(extra_infos))
    return job_info


def get_plugin_info(node, goal_node=None):
    """Return deadline plugin info of the given node.

    Args:
        node (hou.Node): Node to get the plugin info of.
        goal_node (hou.Node, optional): Optional node that will be used to
            resolve any occurrences of $OS.

    Returns:
        dict: Plugin information usable by Deadline.

    """
    goal_node = goal_node if goal_node else node
    return get_parm_values(
        node,
        prefix=constants.PLUGIN_OVERRIDE_PARM_PREFIX,
        remove_prefix=True,
        goal_node=goal_node,
    )


def get_checkbox_value(parm):
    """Return the configured checkbox value of an override parm.

    The user can decide what overrides should be used by using the toggle parm
    next to the parameter. This function returns the value of this toggle, to
    signify if this parm should be used or not.

    Args:
        parm (hou.Parm): Parm to get the checkbox value of.

    Returns:
        bool: Whether or not the given parm should be used or not.

    """
    name = "{}{}".format(constants.OVERRIDE_CHECK_PREFIX, parm.name())
    node = parm.node()
    checkbox = node.parm(name)
    if checkbox:
        return checkbox.eval()
    # No toggle can be found, therefore we just want to return True.
    return True


def get_parm_values(
    node, parm_names=None, prefix=None, remove_prefix=False, goal_node=None
):
    """Return the value of each parameter of a node.

    Args:
        node (hou.Node): Node whose parameter values will be returned.
        parm_names (:obj:`list` of :obj:`str`, optional): Name of the
            parameters that will be queried.
        prefix (str, optional): Instead of passing parm_names, we can also pass
            a prefix. All parameters with the given prefix will be returned.
        remove_prefix (bool, optional): Remove the used prefix before
            returning the dictionary.
        goal_node (hou.Node, optional): If there are any parameters using $OS
            in their value, the result will be replaced with the name of the
            given goal_node.

    Returns:
        dict: Name of the parameters and their value.

    Examples:
        >>> # _foobar_test1: 'the node: $OS'
        >>> # _foobar_test2: 123
        >>> node = hou.node('/out/geometry1')
        >>> get_parm_values(node, prefix='_foobar_')
        {
            _foobar_test1: 'the node: geometry1',
            _foobar_test2: 123
        }
        >>> get_parm_values(node, prefix='_foobar_', remove_prefix=True,
        >>>                 goal_node=hou.node('/out/comp1'))
        {
            test1: 'the node: comp1',
            test2: 123
        }

    """
    goal_node = goal_node if goal_node else node

    if not any((parm_names, prefix)):
        raise ValueError("Either parm_name or prefix need to have a value.")

    if prefix:
        parms = [
            parm
            for parm in node.allParms()
            if all((parm.name().startswith(prefix), get_checkbox_value(parm)))
        ]
    else:
        parms = [node.parm(parm_name) for parm_name in parm_names]
        parms = [parm for parm in parms if get_checkbox_value(parm)]

    # values = {parm.name(): parm.eval() for parm in parms}
    values = {}
    for parm in parms:
        val = parm.eval()
        if isinstance(val, str):
            val = val.replace('\n',' ').replace('\r','')
        values[parm.name()] = val   

    # Any parms that use $OS in their value need to be re-evaluated after
    # cd'ing to the goal_node.
    parms = [parm for parm in parms if "$OS" in parm.rawValue()]
    re_eval_values = {parm.name(): parm.rawValue() for parm in parms}
    hou.cd(goal_node.path())
    for key, raw_value in re_eval_values.items():
        re_eval_values[key] = hou.expandString(raw_value)

    values.update(re_eval_values)

    # Remove prefix.
    if prefix and remove_prefix:
        values = {name[len(prefix) :]: val for name, val in values.items()}

    return values


def add_job_info_parms(node):
    """Add job info override parameters.

    Args:
        node (hou.Node): Node to add the parameters to.

    """
    add_parms_from_config(
        node,
        "job_info_parms",
        "HAL Job Info Overrides",
        constants.JOB_OVERRIDE_PARM_PREFIX,
    )


def add_plugin_info_parms(node):
    """Add plugin info override parameters.

    Args:
        node (hou.Node): Node to add the parameters to.

    """
    main_folder = add_parms_from_config(
        node,
        "plugin_info_parms",
        "HAL Plugin Info Overrides",
        constants.PLUGIN_OVERRIDE_PARM_PREFIX,
    )

    parm_template_group = node.parmTemplateGroup()
    pre_pass_toggle = hou.ToggleParmTemplate(constants.IS_PRE_PASS, "PrePass")
    submit_separately_toggle = hou.ToggleParmTemplate(
        constants.SUBMIT_CHILDREN_SEPARATELY,
        "Submit Children as separate Jobs",
        default_value=False,
    )
    render_mode = hou.MenuParmTemplate(
        constants.RENDER_MODE,
        "Render Mode",
        menu_items=("cache_render", "cache", "render"),
        menu_labels=("Cache & Render", "Cache Only", "Render from Houdini"),
        default_value=0,
    )

    parm_template_group.appendToFolder(main_folder.label(), pre_pass_toggle)
    parm_template_group.appendToFolder(main_folder.label(), submit_separately_toggle)
    parm_template_group.appendToFolder(main_folder.label(), render_mode)
    node.setParmTemplateGroup(parm_template_group)


def create_parms_from_list(parms, prefix):
    """Create Parm Templates from an iterator describing them.

    Args:
        parms (list of dict): Parm Templates to create. Each entry needs to
            have a 'contructor' entry, naming the Parm Template to use.
        prefix (str): Prefix for the created parameters.

    Returns:
        list of hou.ParmTemplate: Created Parm Templates.

    """
    parms = copy.deepcopy(parms)
    created_parms = []
    for parm_config in parms:
        constructor = eval(
            "hou.{}".format(parm_config["constructor"])
        )  # pylint:disable=eval-used
        del parm_config["constructor"]
        try:
            # Deleting the optional 'override' option from the keys, since this
            # would create an error on the constructor and is only used at a
            # later point in make_checkbox_parm().
            del parm_config["override"]
        except KeyError:
            pass

        # Prepend the constant suffix to the name.
        parm_config["name"] = "{}{}".format(prefix, parm_config["name"])

        # Fix incorrect default values in case it has a num component parm.
        if "num_components" in parm_config and "default_value" in parm_config:
            if not isinstance(parm_config["default_value"], (list, tuple)):
                parm_config["default_value"] = (parm_config["default_value"],)

        created_parms.append(constructor(**parm_config))
    return created_parms


def add_parms_from_config(node, parm_list_name, folder_name, prefix):
    """Add parameters from the config.

    Args:
        node (hou.Node): Node to add the parameters to.
        parm_list_name (str): Name of the parameter list.
        folder_name (str): Name of the folder the parameters will be created
            in.
        prefix (str): Prefix for the added parameters.

    Returns:
        hou.FolderParmTemplate: Created main folder.

    """
    parm_template_grp = node.parmTemplateGroup()

    parm_config_list = config.get_config(parm_list_name, auto_expand=False)
    parm_list = create_parms_from_list(parm_config_list, prefix)

    # Create the folder for the Job Info Parameters.
    main_folder = hou.FolderParmTemplate(
        folder_name.replace(" ", "_"), folder_name, folder_type=hou.folderType.Tabs
    )

    has_pools_or_groups = [
        any(
            (
                parm_template.name().endswith("Pool"),
                parm_template.name().endswith("Group"),
            )
        )
        for parm_template in parm_list
    ]
    has_pools_or_groups = any(has_pools_or_groups)
    if has_pools_or_groups:
        add_refresh_buttons(parm_list, main_folder, prefix)

    for i, parm_template in enumerate(parm_list):
        # Edit Pool and Group Parameter Menu List entries.
        if parm_template.name().endswith("Pool"):
            parm_template.setMenuItems(deadline_utils.get_deadline_pools())
        elif parm_template.name().endswith("Group"):
            parm_template.setMenuItems(deadline_utils.get_deadline_groups())

        checkbox_parm = make_checkbox_parm(
            parm_template, parm_config_list[i].get("override", False)
        )
        main_folder.addParmTemplate(checkbox_parm)
        main_folder.addParmTemplate(parm_template)

    parm_template_grp.append(main_folder)
    node.setParmTemplateGroup(parm_template_grp)
    return main_folder


def make_checkbox_parm(parm_template, default_value=False):
    """

    Args:
        parm_template (hou.ParmTemplate): ParmTemplate to create the checkbox
            for.
        default_value (bool, optional): Default Value of the created toggle.
            Defaults to False.

    Returns:
        hou.ToggleParmTemplate: Toggle for override.

    """
    name = "{}{}".format(constants.OVERRIDE_CHECK_PREFIX, parm_template.name())
    checkbox_parm = hou.ToggleParmTemplate(
        name, "", is_label_hidden=True, join_with_next=True, default_value=default_value
    )
    parm_template.setDisableWhen("{{ {} == 0 }}".format(name))
    return checkbox_parm


def add_refresh_buttons(parm_list, main_folder, prefix):
    """Add refresh buttons to the currently building parms.

    Args:
        parm_list (list of hou.ParmTemplate): Parameters that are being added.
        main_folder (hou.FolderParmTemplate): Folder the parms are added to.
        prefix (str): Prefix of the parms that are being constructed.

    """
    refresh_pools = hou.ButtonParmTemplate(
        "btn_{}refresh_pools".format(prefix),
        "Refresh Pools",
        join_with_next=True,
        script_callback_language=hou.scriptLanguage.Python,
    )
    refresh_groups = hou.ButtonParmTemplate(
        "btn_{}refresh_groups".format(prefix),
        "Refresh Groups",
        script_callback_language=hou.scriptLanguage.Python,
    )

    pool_parms = [
        parm_template
        for parm_template in parm_list
        if all(
            (
                parm_template.name().endswith("Pool"),
                parm_template.name().startswith(prefix),
            )
        )
    ]
    group_parms = [
        parm_template
        for parm_template in parm_list
        if all(
            (
                parm_template.name().endswith("Group"),
                parm_template.name().startswith(prefix),
            )
        )
    ]

    pool_parms = [
        'node.parm("{}")'.format(parm_template.name()) for parm_template in pool_parms
    ]
    group_parms = [
        'node.parm("{}")'.format(parm_template.name()) for parm_template in group_parms
    ]

    pool_parms = "[{}]".format(", ".join(pool_parms))
    group_parms = "[{}]".format(", ".join(group_parms))

    callback = (
        "from houdini_deadline_api_submission import deadline_utils\n"
        'node = kwargs["node"]\n'
        "parm_temp_grp = node.parmTemplateGroup()\n"
        "parms = {parms}\n"
        "for parm in parms:\n"
        "    new_parm_template = parm.parmTemplate()\n"
        "    new_parm_template.setMenuItems(deadline_utils.{func})\n"
        "    parm_temp_grp.replace(parm.name(), new_parm_template)\n"
        "node.setParmTemplateGroup(parm_temp_grp)\n"
    )

    refresh_pools.setScriptCallback(
        callback.format(parms=pool_parms, func="get_deadline_pools()")
    )
    refresh_groups.setScriptCallback(
        callback.format(parms=group_parms, func="get_deadline_groups()")
    )

    main_folder.addParmTemplate(refresh_pools)
    main_folder.addParmTemplate(refresh_groups)
