"""Cleanup script utils."""

# Import built-in modules
import os


def create_cleanup_script(identifier, dir_path):
    """Create a python script that cleans up the given folder on execution.

    Args:
        identifier (str): Identifier used by all outputs in this folder.
        dir_path (str): Path to the directory that should be cleaned up by the
            script.

    Returns:
        str: Path to the generated cleanup script.

    """
    # Ensure the directory exists.
    if not os.path.isdir(dir_path):
        try:
            os.makedirs(dir_path)
        except (IOError, OSError):
            raise OSError(
                'Missing permissions to create folder "{}". Please make sure '
                "you are assigned to the project on Shotgun.".format(dir_path)
            )

    script_path = os.path.join(dir_path, "{}__{}.py".format(identifier, "cleanup"))

    expression = """# Import future modules
from __future__ import print_function
# Import built-in modules
import os

identifier = {identifier!r}
dir_path = {dir_path!r}

for root, _, files in os.walk(dir_path):
    for file_name in files:
        # Skip hip files.
        if file_name.endswith(".hip"):
            continue
        if identifier in file_name:
            file_path = os.path.join(root, file_name)
            print("Deleting {{}}...".format(file_path))
            os.remove(os.path.join(root, file_name))
""".format(
        identifier=identifier, dir_path=dir_path
    )

    with open(script_path, "w") as script_file:
        try:
            script_file.write(expression)
        except (IOError, OSError):
            raise OSError(
                'Missing permissions to write file "{}". Please make sure you '
                "are assigned to the project on Shotgun.".format(script_path)
            )

    return script_path
